<template>
  <div class="vulnerability-list">
    <div class="page-header">
      <h1>漏洞列表</h1>
      <el-select
        v-model="selectedTaskId"
        placeholder="选择扫描任务"
        clearable
        @change="filterVulnerabilities"
      >
        <el-option
          v-for="task in tasks"
          :key="task.id"
          :label="getTaskLabel(task)"
          :value="task.id"
        />
      </el-select>
    </div>

    <el-table :data="filteredVulnerabilities" style="width: 100%">
      <el-table-column prop="title" label="漏洞标题" width="250" />
      <el-table-column prop="severity" label="危险等级" width="100">
        <template #default="scope">
          <el-tag :type="getSeverityType(scope.row.severity)">
            {{ getSeverityName(scope.row.severity) }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="description" label="漏洞描述" />
      <el-table-column prop="solution" label="修复建议" />
      <el-table-column prop="created_at" label="发现时间" width="180">
        <template #default="scope">
          {{ new Date(scope.row.created_at).toLocaleString() }}
        </template>
      </el-table-column>
    </el-table>

    <el-empty
      v-if="filteredVulnerabilities.length === 0"
      description="暂无漏洞信息"
    />
  </div>
</template>

<script>
import { ref, computed, onMounted, watch } from 'vue'
import { useStore } from 'vuex'
import { useRoute } from 'vue-router'

export default {
  name: 'VulnerabilityList',
  setup() {
    const store = useStore()
    const route = useRoute()
    const selectedTaskId = ref(null)
    const tasks = ref([])
    const vulnerabilities = ref([])

    const fetchData = async () => {
      await Promise.all([
        store.dispatch('fetchTasks'),
        store.dispatch('fetchVulnerabilities')
      ])
      tasks.value = store.state.tasks
      vulnerabilities.value = store.state.vulnerabilities
    }

    const getTaskLabel = (task) => {
      const target = store.getters.getTargetById(task.target)
      const scanType = getScanTypeName(task.scan_type)
      return `${target ? target.url : '未知目标'} - ${scanType}`
    }

    const getScanTypeName = (type) => {
      const types = {
        'port': '端口扫描',
        'os': '操作系统扫描',
        'sql': 'SQL注入扫描',
        'xss': 'XSS扫描',
        'dir': '目录扫描',
        'info': '信息泄露扫描'
      }
      return types[type] || type
    }

    const getSeverityName = (severity) => {
      const severities = {
        'low': '低危',
        'medium': '中危',
        'high': '高危',
        'critical': '严重'
      }
      return severities[severity] || severity
    }

    const getSeverityType = (severity) => {
      const types = {
        'low': 'info',
        'medium': 'warning',
        'high': 'danger',
        'critical': 'danger'
      }
      return types[severity] || ''
    }

    const filteredVulnerabilities = computed(() => {
      if (!selectedTaskId.value) {
        return vulnerabilities.value
      }
      return vulnerabilities.value.filter(v => v.scan_task === selectedTaskId.value)
    })

    const filterVulnerabilities = (taskId) => {
      selectedTaskId.value = taskId
    }

    onMounted(async () => {
      await fetchData()
      // 如果URL中有taskId参数，自动选择对应的任务
      const taskId = route.query.taskId
      if (taskId) {
        selectedTaskId.value = parseInt(taskId)
      }
    })

    // 监听路由变化，更新选中的任务
    watch(
      () => route.query.taskId,
      (newTaskId) => {
        if (newTaskId) {
          selectedTaskId.value = parseInt(newTaskId)
        }
      }
    )

    return {
      tasks,
      selectedTaskId,
      filteredVulnerabilities,
      getTaskLabel,
      getSeverityName,
      getSeverityType,
      filterVulnerabilities
    }
  }
}
</script>

<style scoped>
.vulnerability-list {
  padding: 20px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.el-select {
  width: 400px;
}
</style> 